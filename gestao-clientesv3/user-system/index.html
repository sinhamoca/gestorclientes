<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gest√£o de Clientes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_URL = 'http://37.60.235.47:3001/api';

    const api = {
      async request(endpoint, options = {}) {
        const token = localStorage.getItem('user_token');
        const headers = {
          'Content-Type': 'application/json',
          ...(token && { Authorization: `Bearer ${token}` }),
          ...options.headers
        };
        const response = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Erro');
        return data;
      },
      login: (email, password) => api.request('/auth/login', { method: 'POST', body: JSON.stringify({ email, password }) }),
      getMe: () => api.request('/auth/me'),
      
      // Planos
      getPlans: () => api.request('/plans'),
      createPlan: (data) => api.request('/plans', { method: 'POST', body: JSON.stringify(data) }),
      updatePlan: (id, data) => api.request(`/plans/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
      deletePlan: (id) => api.request(`/plans/${id}`, { method: 'DELETE' }),
      
      // Servidores
      getServers: () => api.request('/servers'),
      createServer: (data) => api.request('/servers', { method: 'POST', body: JSON.stringify(data) }),
      updateServer: (id, data) => api.request(`/servers/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
      deleteServer: (id) => api.request(`/servers/${id}`, { method: 'DELETE' }),
      
      // Clientes
      getClients: (params) => {
        const query = new URLSearchParams(params).toString();
        return api.request(`/clients?${query}`);
      },
      getClientStats: () => api.request('/clients/stats'),
      createClient: (data) => api.request('/clients', { method: 'POST', body: JSON.stringify(data) }),
      updateClient: (id, data) => api.request(`/clients/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
      deleteClient: (id) => api.request(`/clients/${id}`, { method: 'DELETE' }),

      // Templates
      getTemplates: () => api.request('/templates'),
      createTemplate: (data) => api.request('/templates', { method: 'POST', body: JSON.stringify(data) }),
      updateTemplate: (id, data) => api.request(`/templates/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
      deleteTemplate: (id) => api.request(`/templates/${id}`, { method: 'DELETE' }),
      previewTemplate: (id, clientId) => api.request(`/templates/${id}/preview${clientId ? `?client_id=${clientId}` : ''}`),

      // Lembretes
      getReminders: () => api.request('/reminders'),
      createReminder: (data) => api.request('/reminders', { method: 'POST', body: JSON.stringify(data) }),
      updateReminder: (id, data) => api.request(`/reminders/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
      deleteReminder: (id) => api.request(`/reminders/${id}`, { method: 'DELETE' }),

      // WhatsApp / Evolution API
      connectWhatsApp: () => api.request('/whatsapp/connect', { method: 'POST' }),
      getQRCode: () => api.request('/whatsapp/qrcode'),
      checkWhatsAppStatus: () => api.request('/whatsapp/status'),
      disconnectWhatsApp: () => api.request('/whatsapp/disconnect', { method: 'POST' }),
      deleteWhatsAppInstance: () => api.request('/whatsapp/instance', { method: 'DELETE' }) // ‚Üê NOVA FUN√á√ÉO
    };

    // Login Component
    function Login({ onLogin }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          const data = await api.login(email, password);
          if (data.user.role === 'admin') {
            setError('Administradores devem usar o painel admin');
            return;
          }
          localStorage.setItem('user_token', data.token);
          localStorage.setItem('user_data', JSON.stringify(data.user));
          onLogin(data.user);
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-indigo-600 px-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div className="text-center mb-8">
              <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-3xl font-bold">
                GC
              </div>
              <h1 className="text-3xl font-bold text-gray-800">Bem-vindo</h1>
              <p className="text-gray-600 mt-2">Sistema de Gest√£o de Clientes</p>
            </div>
            <form onSubmit={handleSubmit} className="space-y-6">
              {error && <div className="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded">{error}</div>}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required />
              </div>
              <button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-semibold py-3 rounded-lg transition disabled:opacity-50">
                {loading ? 'Entrando...' : 'Entrar'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    // Modal Templates
    function TemplatesModal({ templates, onClose, onRefresh }) {
      const [formData, setFormData] = useState({ name: '', type: 'pre_vencimento', message: '' });
      const [loading, setLoading] = useState(false);
      const [editingId, setEditingId] = useState(null);
      const [showPreview, setShowPreview] = useState(false);
      const [preview, setPreview] = useState('');

      const templateTypes = [
        { value: 'pre_vencimento', label: 'Pr√©-vencimento' },
        { value: 'vencimento_dia', label: 'Vencimento no dia' },
        { value: 'pos_vencimento', label: 'P√≥s-vencimento' },
        { value: 'personalizado', label: 'Personalizado' }
      ];

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
          if (editingId) {
            await api.updateTemplate(editingId, formData);
          } else {
            await api.createTemplate(formData);
          }
          setFormData({ name: '', type: 'pre_vencimento', message: '' });
          setEditingId(null);
          onRefresh();
        } catch (error) {
          alert(error.message);
        } finally {
          setLoading(false);
        }
      };

      const handleEdit = (template) => {
        setFormData({
          name: template.name,
          type: template.type,
          message: template.message
        });
        setEditingId(template.id);
      };

      const handleDelete = async (id) => {
        if (!confirm('Excluir este template?')) return;
        try {
          await api.deleteTemplate(id);
          onRefresh();
        } catch (error) {
          alert(error.message);
        }
      };

      const handlePreview = async () => {
        if (!formData.message) return;
        try {
          const result = await api.previewTemplate(editingId || 0, null);
          setPreview(result.preview || formData.message
            .replace(/\{\{nome\}\}/g, 'Jo√£o Silva')
            .replace(/\{\{vencimento\}\}/g, '25/12/2024')
            .replace(/\{\{valor\}\}/g, 'R$ 25,00')
            .replace(/\{\{servidor\}\}/g, 'Netflix')
            .replace(/\{\{plano\}\}/g, '1 m√™s 2 telas')
            .replace(/\{\{dias\}\}/g, '3')
            .replace(/\{\{whatsapp\}\}/g, '85999999999')
          );
          setShowPreview(true);
        } catch (error) {
          alert(error.message);
        }
      };

      const insertVariable = (variable) => {
        const textarea = document.getElementById('template-message');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = formData.message;
        const newText = text.substring(0, start) + variable + text.substring(end);
        setFormData({...formData, message: newText});
        setTimeout(() => {
          textarea.focus();
          textarea.setSelectionRange(start + variable.length, start + variable.length);
        }, 0);
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
            <div className="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
              <h3 className="text-xl font-bold">Gerenciar Templates</h3>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
            </div>
            <div className="p-6">
              <form onSubmit={handleSubmit} className="mb-6 border rounded-lg p-4 bg-blue-50">
                <h4 className="font-semibold mb-4">{editingId ? 'Editar Template' : 'Novo Template'}</h4>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Nome do Template</label>
                    <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full px-4 py-2 border rounded-lg" placeholder="Lembrete 3 dias antes" required />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Tipo</label>
                    <select value={formData.type} onChange={(e) => setFormData({...formData, type: e.target.value})} className="w-full px-4 py-2 border rounded-lg">
                      {templateTypes.map(t => <option key={t.value} value={t.value}>{t.label}</option>)}
                    </select>
                  </div>
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium mb-2">Mensagem</label>
                  <textarea id="template-message" value={formData.message} onChange={(e) => setFormData({...formData, message: e.target.value})} className="w-full px-4 py-2 border rounded-lg" rows="6" placeholder="Ol√° {{nome}}, seu plano {{plano}} vence em {{dias}} dias..." required></textarea>
                  
                  <div className="mt-2 flex flex-wrap gap-2">
                    <span className="text-xs text-gray-600 font-medium">Vari√°veis dispon√≠veis:</span>
                    {['{{nome}}', '{{vencimento}}', '{{valor}}', '{{servidor}}', '{{plano}}', '{{dias}}', '{{whatsapp}}'].map(v => (
                      <button key={v} type="button" onClick={() => insertVariable(v)} className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                        {v}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="flex gap-3">
                  <button type="button" onClick={handlePreview} className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    üëÅÔ∏è Preview
                  </button>
                  {editingId && (
                    <button type="button" onClick={() => { setEditingId(null); setFormData({ name: '', type: 'pre_vencimento', message: '' }); }} className="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">
                      Cancelar
                    </button>
                  )}
                  <button type="submit" disabled={loading} className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                    {loading ? 'Salvando...' : editingId ? 'Atualizar' : 'Adicionar'}
                  </button>
                </div>
              </form>

              {showPreview && (
                <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                  <div className="flex justify-between items-center mb-2">
                    <h4 className="font-semibold text-green-800">Preview da Mensagem</h4>
                    <button onClick={() => setShowPreview(false)} className="text-green-600 hover:text-green-800">‚úï</button>
                  </div>
                  <div className="bg-white p-3 rounded border text-sm whitespace-pre-wrap">{preview}</div>
                </div>
              )}

              <div className="space-y-2">
                <h4 className="font-semibold mb-3">Templates Cadastrados</h4>
                {templates.map(template => (
                  <div key={template.id} className="flex justify-between items-start p-4 bg-gray-50 rounded-lg border hover:border-blue-300 transition">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="font-medium">{template.name}</span>
                        <span className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">
                          {templateTypes.find(t => t.value === template.type)?.label}
                        </span>
                      </div>
                      <p className="text-sm text-gray-600 line-clamp-2">{template.message}</p>
                    </div>
                    <div className="flex gap-2 ml-4">
                      <button onClick={() => handleEdit(template)} className="text-blue-600 hover:text-blue-800 text-sm">Editar</button>
                      <button onClick={() => handleDelete(template.id)} className="text-red-600 hover:text-red-800 text-sm">Excluir</button>
                    </div>
                  </div>
                ))}
                {templates.length === 0 && <p className="text-gray-500 text-center py-4">Nenhum template cadastrado</p>}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Modal WhatsApp - VERS√ÉO FINAL
    function WhatsAppModal({ onClose }) {
      const [status, setStatus] = useState('loading'); // loading, disconnected, connecting, connected
      const [qrCode, setQrCode] = useState(null);
      const [phoneNumber, setPhoneNumber] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      // Verifica√ß√£o inicial
      useEffect(() => {
        initialCheck();
      }, []);

      // Intervalo para verificar conex√£o (apenas quando conectando)
      useEffect(() => {
        if (status === 'connecting' && qrCode) {
          const interval = setInterval(checkIfConnected, 3000);
          return () => clearInterval(interval);
        }
      }, [status, qrCode]);

      const initialCheck = async () => {
        try {
          const data = await api.checkWhatsAppStatus();
          if (data.connected) {
            setStatus('connected');
            setPhoneNumber(data.phoneNumber);
          } else {
            setStatus('disconnected');
          }
        } catch (error) {
          console.error('Erro ao verificar status:', error);
          setStatus('disconnected');
        }
      };

      const checkIfConnected = async () => {
        try {
          const data = await api.getQRCode();
          if (data.connected) {
            setStatus('connected');
            setPhoneNumber(data.phoneNumber);
            setQrCode(null);
          }
        } catch (error) {
          console.error('Erro ao verificar conex√£o:', error);
        }
      };

      const handleConnect = async () => {
        setLoading(true);
        setError('');
        setQrCode(null);
        
        try {
          const data = await api.connectWhatsApp();
          
          if (data.connected) {
            setStatus('connected');
            setPhoneNumber(data.phoneNumber);
            setQrCode(null);
          } else if (data.qrCode) {
            setQrCode(data.qrCode);
            setStatus('connecting');
          } else {
            throw new Error('QR Code n√£o foi gerado');
          }
        } catch (error) {
          setError(error.message);
          setStatus('disconnected');
        } finally {
          setLoading(false);
        }
      };
      
      const handleDeleteInstance = async () => {
        if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° excluir completamente a inst√¢ncia do WhatsApp. Voc√™ precisar√° escanear o QR Code novamente. Deseja continuar?')) return;
        setLoading(true);
        try {
          await api.deleteWhatsAppInstance();
          setStatus('disconnected');
          setQrCode(null);
          setPhoneNumber(null);
          alert('Inst√¢ncia exclu√≠da com sucesso!');
        } catch (error) {
          setError(error.message);
        } finally {
          setLoading(false);
        }
      };

      const handleDisconnect = async () => {
        if (!confirm('Desconectar WhatsApp?')) return;
        setLoading(true);
        try {
          await api.disconnectWhatsApp();
          setStatus('disconnected');
          setQrCode(null);
          setPhoneNumber(null);
          alert('Desconectado com sucesso!');
        } catch (error) {
          setError(error.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full">
            <div className="p-6 border-b flex justify-between items-center">
              <h3 className="text-xl font-bold">üîó Conectar WhatsApp</h3>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
            </div>
            
            <div className="p-6">
              {error && (
                <div className="mb-4 bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded">
                  {error}
                </div>
              )}

              {status === 'loading' && (
                <div className="text-center py-12">
                  <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                  <p className="text-gray-600">Verificando conex√£o...</p>
                </div>
              )}

              {status === 'disconnected' && (
                <div className="text-center py-8">
                  <div className="w-24 h-24 bg-gray-200 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl">
                    üì±
                  </div>
                  <h4 className="text-lg font-semibold mb-2">WhatsApp Desconectado</h4>
                  <p className="text-gray-600 mb-6">Conecte seu WhatsApp para enviar lembretes autom√°ticos</p>
                  <button 
                    onClick={handleConnect}
                    disabled={loading}
                    className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 font-semibold"
                  >
                    {loading ? 'Gerando QR Code...' : 'üîó Conectar WhatsApp'}
                  </button>
                </div>
              )}

              {status === 'connecting' && qrCode && (
                <div className="text-center py-8">
                  <h4 className="text-lg font-semibold mb-4">üì≤ Escaneie o QR Code</h4>
                  <div className="bg-white p-4 rounded-lg inline-block shadow-lg mb-4">
                    <img src={qrCode} alt="QR Code" className="w-64 h-64" />
                  </div>
                  <div className="bg-blue-50 border-l-4 border-blue-500 p-4 text-left mb-4">
                    <p className="font-semibold text-blue-800 mb-2">Como conectar:</p>
                    <ol className="text-sm text-blue-700 space-y-1 list-decimal list-inside">
                      <li>Abra o WhatsApp no seu celular</li>
                      <li>Toque em Mais op√ß√µes (‚ãÆ) e selecione "Aparelhos conectados"</li>
                      <li>Toque em "Conectar um aparelho"</li>
                      <li>Aponte seu celular para esta tela para escanear o c√≥digo QR</li>
                    </ol>
                  </div>
                  <p className="text-sm text-gray-500 mb-2">
                    ‚ú® A conex√£o ser√° detectada automaticamente
                  </p>
                  <button 
                    onClick={handleConnect}
                    disabled={loading}
                    className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 text-sm"
                  >
                    {loading ? 'Gerando...' : 'üîÑ Gerar Novo QR Code'}
                  </button>
                </div>
              )}

              {status === 'connected' && (
                <div className="text-center py-8">
                  <div className="w-24 h-24 bg-green-100 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl">
                    ‚úÖ
                  </div>
                  <h4 className="text-lg font-semibold mb-2 text-green-600">WhatsApp Conectado!</h4>
                  <p className="text-gray-600 mb-2">N√∫mero: <strong>{phoneNumber}</strong></p>
                  <p className="text-sm text-gray-500 mb-6">Seu WhatsApp est√° pronto para enviar mensagens autom√°ticas</p>
                  <div className="flex gap-3 justify-center">
                    <button 
                      onClick={handleDisconnect}
                      disabled={loading}
                      className="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 disabled:opacity-50 font-semibold"
                    >
                      {loading ? 'Desconectando...' : 'Desconectar'}
                    </button>
                    <button 
                      onClick={handleDeleteInstance}
                      disabled={loading}
                      className="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 font-semibold"
                    >
                      {loading ? 'Excluindo...' : 'üóëÔ∏è Excluir Inst√¢ncia'}
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Modal Lembretes
    function RemindersModal({ reminders, templates, onClose, onRefresh }) {
      const [formData, setFormData] = useState({ name: '', template_id: '', days_offset: '0', send_time: '09:00' });
      const [loading, setLoading] = useState(false);
      const [editingId, setEditingId] = useState(null);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
          const data = {
            ...formData,
            days_offset: parseInt(formData.days_offset),
            send_time: formData.send_time + ':00'
          };
          
          if (editingId) {
            await api.updateReminder(editingId, data);
          } else {
            await api.createReminder(data);
          }
          setFormData({ name: '', template_id: '', days_offset: '0', send_time: '09:00' });
          setEditingId(null);
          onRefresh();
        } catch (error) {
          alert(error.message);
        } finally {
          setLoading(false);
        }
      };

      const handleEdit = (reminder) => {
        setFormData({
          name: reminder.name,
          template_id: reminder.template_id.toString(),
          days_offset: reminder.days_offset.toString(),
          send_time: reminder.send_time.substring(0, 5),
          is_active: reminder.is_active
        });
        setEditingId(reminder.id);
      };

      const handleDelete = async (id) => {
        if (!confirm('Excluir este lembrete?')) return;
        try {
          await api.deleteReminder(id);
          onRefresh();
        } catch (error) {
          alert(error.message);
        }
      };

      const toggleActive = async (reminder) => {
        try {
          await api.updateReminder(reminder.id, { ...reminder, is_active: !reminder.is_active });
          onRefresh();
        } catch (error) {
          alert(error.message);
        }
      };

      const getDaysLabel = (days) => {
        if (days === 0) return 'No dia do vencimento';
        if (days < 0) return `${Math.abs(days)} dia${Math.abs(days) > 1 ? 's' : ''} antes`;
        return `${days} dia${days > 1 ? 's' : ''} depois`;
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
            <div className="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
              <h3 className="text-xl font-bold">Gerenciar Lembretes</h3>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
            </div>
            <div className="p-6">
              <form onSubmit={handleSubmit} className="mb-6 border rounded-lg p-4 bg-green-50">
                <h4 className="font-semibold mb-4">{editingId ? 'Editar Lembrete' : 'Novo Lembrete'}</h4>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Nome do Lembrete</label>
                    <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full px-4 py-2 border rounded-lg" placeholder="Lembrete 3 dias antes" required />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Template</label>
                    <select value={formData.template_id} onChange={(e) => setFormData({...formData, template_id: e.target.value})} className="w-full px-4 py-2 border rounded-lg" required>
                      <option value="">Selecione um template</option>
                      {templates.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                    </select>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Dias em rela√ß√£o ao vencimento</label>
                    <select value={formData.days_offset} onChange={(e) => setFormData({...formData, days_offset: e.target.value})} className="w-full px-4 py-2 border rounded-lg">
                      <option value="-7">7 dias antes</option>
                      <option value="-5">5 dias antes</option>
                      <option value="-3">3 dias antes</option>
                      <option value="-2">2 dias antes</option>
                      <option value="-1">1 dia antes</option>
                      <option value="0">No dia do vencimento</option>
                      <option value="1">1 dia depois</option>
                      <option value="2">2 dias depois</option>
                      <option value="3">3 dias depois</option>
                      <option value="5">5 dias depois</option>
                      <option value="7">7 dias depois</option>
                      <option value="10">10 dias depois</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Hor√°rio de Envio</label>
                    <input type="time" value={formData.send_time} onChange={(e) => setFormData({...formData, send_time: e.target.value})} className="w-full px-4 py-2 border rounded-lg" required />
                  </div>
                </div>

                <div className="flex gap-3">
                  {editingId && (
                    <button type="button" onClick={() => { setEditingId(null); setFormData({ name: '', template_id: '', days_offset: '0', send_time: '09:00' }); }} className="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">
                      Cancelar
                    </button>
                  )}
                  <button type="submit" disabled={loading} className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
                    {loading ? 'Salvando...' : editingId ? 'Atualizar' : 'Adicionar'}
                  </button>
                </div>
              </form>

              <div className="space-y-2">
                <h4 className="font-semibold mb-3">Lembretes Configurados</h4>
                {reminders.map(reminder => (
                  <div key={reminder.id} className="flex justify-between items-center p-4 bg-gray-50 rounded-lg border hover:border-green-300 transition">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="font-medium">{reminder.name}</span>
                        <span className={`text-xs px-2 py-1 rounded ${reminder.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'}`}>
                          {reminder.is_active ? 'Ativo' : 'Inativo'}
                        </span>
                      </div>
                      <div className="text-sm text-gray-600">
                        <span className="font-medium">{getDaysLabel(reminder.days_offset)}</span> ‚Ä¢ {reminder.send_time.substring(0, 5)} ‚Ä¢ Template: {reminder.template_name}
                      </div>
                    </div>
                    <div className="flex gap-2 ml-4">
                      <button onClick={() => toggleActive(reminder)} className={`text-sm ${reminder.is_active ? 'text-yellow-600 hover:text-yellow-800' : 'text-green-600 hover:text-green-800'}`}>
                        {reminder.is_active ? 'Desativar' : 'Ativar'}
                      </button>
                      <button onClick={() => handleEdit(reminder)} className="text-blue-600 hover:text-blue-800 text-sm">Editar</button>
                      <button onClick={() => handleDelete(reminder.id)} className="text-red-600 hover:text-red-800 text-sm">Excluir</button>
                    </div>
                  </div>
                ))}
                {reminders.length === 0 && <p className="text-gray-500 text-center py-4">Nenhum lembrete configurado</p>}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Modal Planos
    function PlansModal({ plans, onClose, onRefresh }) {
      const [formData, setFormData] = useState({ name: '', duration_months: '1' });
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
          await api.createPlan(formData);
          setFormData({ name: '', duration_months: '1' });
          onRefresh();
        } catch (error) {
          alert(error.message);
        } finally {
          setLoading(false);
        }
      };

      const handleDelete = async (id) => {
        if (!confirm('Excluir este plano?')) return;
        try {
          await api.deletePlan(id);
          onRefresh();
        } catch (error) {
          alert(error.message);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
            <div className="p-6 border-b flex justify-between items-center">
              <h3 className="text-xl font-bold">Gerenciar Planos</h3>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <div className="p-6">
              <form onSubmit={handleSubmit} className="mb-6">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Nome do Plano</label>
                    <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full px-4 py-2 border rounded-lg" placeholder="1 m√™s 2 telas" required />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Dura√ß√£o (meses)</label>
                    <input type="number" min="1" value={formData.duration_months} onChange={(e) => setFormData({...formData, duration_months: e.target.value})} className="w-full px-4 py-2 border rounded-lg" required />
                  </div>
                </div>
                <button type="submit" disabled={loading} className="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                  {loading ? 'Adicionando...' : 'Adicionar Plano'}
                </button>
              </form>
              <div className="space-y-2">
                {plans.map(plan => (
                  <div key={plan.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                      <span className="font-medium">{plan.name}</span>
                      <span className="text-sm text-gray-600 ml-2">({plan.duration_months} {plan.duration_months === 1 ? 'm√™s' : 'meses'})</span>
                    </div>
                    <button onClick={() => handleDelete(plan.id)} className="text-red-600 hover:text-red-800">Excluir</button>
                  </div>
                ))}
                {plans.length === 0 && <p className="text-gray-500 text-center py-4">Nenhum plano cadastrado</p>}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Modal Servidores
    function ServersModal({ servers, onClose, onRefresh }) {
      const [formData, setFormData] = useState({ name: '', cost_per_screen: '' });
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
          await api.createServer(formData);
          setFormData({ name: '', cost_per_screen: '' });
          onRefresh();
        } catch (error) {
          alert(error.message);
        } finally {
          setLoading(false);
        }
      };

      const handleDelete = async (id) => {
        if (!confirm('Excluir este servidor?')) return;
        try {
          await api.deleteServer(id);
          onRefresh();
        } catch (error) {
          alert(error.message);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
            <div className="p-6 border-b flex justify-between items-center">
              <h3 className="text-xl font-bold">Gerenciar Servidores</h3>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <div className="p-6">
              <form onSubmit={handleSubmit} className="mb-6">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Nome do Servidor</label>
                    <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full px-4 py-2 border rounded-lg" placeholder="Netflix" required />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Custo por Tela (R$)</label>
                    <input type="number" step="0.01" min="0" value={formData.cost_per_screen} onChange={(e) => setFormData({...formData, cost_per_screen: e.target.value})} className="w-full px-4 py-2 border rounded-lg" placeholder="10.00" required />
                  </div>
                </div>
                <button type="submit" disabled={loading} className="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                  {loading ? 'Adicionando...' : 'Adicionar Servidor'}
                </button>
              </form>
              <div className="space-y-2">
                {servers.map(server => (
                  <div key={server.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                      <span className="font-medium">{server.name}</span>
                      <span className="text-sm text-gray-600 ml-2">R$ {parseFloat(server.cost_per_screen).toFixed(2)}/tela</span>
                    </div>
                    <button onClick={() => handleDelete(server.id)} className="text-red-600 hover:text-red-800">Excluir</button>
                  </div>
                ))}
                {servers.length === 0 && <p className="text-gray-500 text-center py-4">Nenhum servidor cadastrado</p>}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Modal Cliente
    function ClientModal({ client, plans, servers, onClose, onSave }) {
      const isEdit = !!client;
      const [loading, setLoading] = useState(false);
      const [formData, setFormData] = useState({
        name: client?.name || '',
        whatsapp_number: client?.whatsapp_number || '',
        plan_id: client?.plan_id || '',
        server_id: client?.server_id || '',
        price_value: client?.price_value || '',
        due_date: client?.due_date ? client.due_date.split('T')[0] : '',
        username: client?.username || '',
        password: client?.password || '',
        mac_address: client?.mac_address || '',
        device_key: client?.device_key || '',
        notes: client?.notes || '',
        is_active: client?.is_active ?? true
      });

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
          if (isEdit) {
            await api.updateClient(client.id, formData);
          } else {
            await api.createClient(formData);
          }
          onSave();
        } catch (error) {
          alert(error.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-screen overflow-y-auto">
            <div className="p-6 border-b flex justify-between items-center">
              <h3 className="text-xl font-bold">{isEdit ? 'Editar Cliente' : 'Novo Cliente'}</h3>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <form onSubmit={handleSubmit} className="p-6">
              <div className="space-y-4">
                <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                  <p className="text-sm font-medium text-blue-800">Campos Obrigat√≥rios</p>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Nome *</label>
                    <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full px-4 py-2 border rounded-lg" placeholder="Isaac Mendes" required />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">WhatsApp *</label>
                    <input type="text" value={formData.whatsapp_number} onChange={(e) => setFormData({...formData, whatsapp_number: e.target.value})} className="w-full px-4 py-2 border rounded-lg" placeholder="5585940219 63" required />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Plano *</label>
                    <select value={formData.plan_id} onChange={(e) => setFormData({...formData, plan_id: e.target.value})} className="w-full px-4 py-2 border rounded-lg" required>
                      <option value="">Selecione</option>
                      {plans.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Servidor *</label>
                    <select value={formData.server_id} onChange={(e) => setFormData({...formData, server_id: e.target.value})} className="w-full px-4 py-2 border rounded-lg" required>
                      <option value="">Selecione</option>
                      {servers.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Valor (R$) *</label>
                    <input type="number" step="0.01" min="0" value={formData.price_value} onChange={(e) => setFormData({...formData, price_value: e.target.value})} className="w-full px-4 py-2 border rounded-lg" placeholder="25.00" required />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Vencimento *</label>
                    <input type="date" value={formData.due_date} onChange={(e) => setFormData({...formData, due_date: e.target.value})} className="w-full px-4 py-2 border rounded-lg" required />
                  </div>
                </div>

                <div className="bg-gray-50 border-l-4 border-gray-400 p-4 my-4">
                  <p className="text-sm font-medium text-gray-700">Campos Opcionais</p>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Usu√°rio</label>
                    <input type="text" value={formData.username} onChange={(e) => setFormData({...formData, username: e.target.value})} className="w-full px-4 py-2 border rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Senha</label>
                    <input type="text" value={formData.password} onChange={(e) => setFormData({...formData, password: e.target.value})} className="w-full px-4 py-2 border rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">MAC Address</label>
                    <input type="text" value={formData.mac_address} onChange={(e) => setFormData({...formData, mac_address: e.target.value})} className="w-full px-4 py-2 border rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Device Key</label>
                    <input type="text" value={formData.device_key} onChange={(e) => setFormData({...formData, device_key: e.target.value})} className="w-full px-4 py-2 border rounded-lg" />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">Observa√ß√µes</label>
                  <textarea value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} className="w-full px-4 py-2 border rounded-lg" rows="3"></textarea>
                </div>

                {isEdit && (
                  <div className="flex items-center">
                    <input type="checkbox" checked={formData.is_active} onChange={(e) => setFormData({...formData, is_active: e.target.checked})} className="w-4 h-4 text-blue-600 rounded" />
                    <label className="ml-2 text-sm font-medium">Cliente ativo</label>
                  </div>
                )}
              </div>

              <div className="flex gap-3 mt-6">
                <button type="button" onClick={onClose} className="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
                <button type="submit" disabled={loading} className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                  {loading ? 'Salvando...' : 'Salvar'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // Dashboard Principal
    function Dashboard({ user, onLogout }) {
      const [view, setView] = useState('clients');
      const [clients, setClients] = useState([]);
      const [stats, setStats] = useState(null);
      const [plans, setPlans] = useState([]);
      const [servers, setServers] = useState([]);
      const [templates, setTemplates] = useState([]);
      const [reminders, setReminders] = useState([]);
      const [loading, setLoading] = useState(true);
      const [search, setSearch] = useState('');
      const [statusFilter, setStatusFilter] = useState('');
      const [showModal, setShowModal] = useState(null);
      const [editingClient, setEditingClient] = useState(null);

      useEffect(() => {
        loadData();
      }, [search, statusFilter]);

      const loadData = async () => {
        try {
          const [clientsData, statsData, plansData, serversData, templatesData, remindersData] = await Promise.all([
            api.getClients({ search, status: statusFilter }),
            api.getClientStats(),
            api.getPlans(),
            api.getServers(),
            api.getTemplates(),
            api.getReminders()
          ]);
          setClients(clientsData);
          setStats(statsData);
          setPlans(plansData);
          setServers(serversData);
          setTemplates(templatesData);
          setReminders(remindersData);
        } catch (error) {
          console.error('Erro ao carregar dados:', error);
        } finally {
          setLoading(false);
        }
      };

      const handleDeleteClient = async (id) => {
        if (!confirm('Excluir este cliente?')) return;
        try {
          await api.deleteClient(id);
          loadData();
        } catch (error) {
          alert(error.message);
        }
      };

      const getStatusBadge = (client) => {
        if (!client.is_active) return <span className="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs">Inativo</span>;
        if (client.is_expired) return <span className="px-2 py-1 bg-red-200 text-red-700 rounded text-xs">Vencido</span>;
        if (client.days_until_due <= 7) return <span className="px-2 py-1 bg-yellow-200 text-yellow-700 rounded text-xs">Vence em {client.days_until_due}d</span>;
        return <span className="px-2 py-1 bg-green-200 text-green-700 rounded text-xs">Ativo</span>;
      };

      return (
        <div className="min-h-screen bg-gray-50">
          <header className="bg-white shadow">
            <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
              <h1 className="text-xl font-bold text-gray-800">{user.name}</h1>
              <div className="flex gap-2">
                <button onClick={() => setShowModal('whatsapp')} className="px-4 py-2 text-sm bg-green-100 hover:bg-green-200 text-green-700 rounded-lg font-semibold">üì± WhatsApp</button>
                <button onClick={() => setShowModal('plans')} className="px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">üìã Planos</button>
                <button onClick={() => setShowModal('servers')} className="px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">üñ•Ô∏è Servidores</button>
                <button onClick={() => setShowModal('templates')} className="px-4 py-2 text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg">üí¨ Templates</button>
                <button onClick={() => setShowModal('reminders')} className="px-4 py-2 text-sm bg-green-100 hover:bg-green-200 text-green-700 rounded-lg">üîî Lembretes</button>
                <button onClick={onLogout} className="px-4 py-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600">Sair</button>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 py-8">
            {stats && (
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div className="bg-white rounded-lg shadow p-6">
                  <p className="text-gray-600 text-sm">Total</p>
                  <p className="text-3xl font-bold mt-2">{stats.total}</p>
                </div>
                <div className="bg-white rounded-lg shadow p-6">
                  <p className="text-gray-600 text-sm">Ativos</p>
                  <p className="text-3xl font-bold mt-2 text-green-600">{stats.active}</p>
                </div>
                <div className="bg-white rounded-lg shadow p-6">
                  <p className="text-gray-600 text-sm">Vencidos</p>
                  <p className="text-3xl font-bold mt-2 text-red-600">{stats.expired}</p>
                </div>
                <div className="bg-white rounded-lg shadow p-6">
                  <p className="text-gray-600 text-sm">Vencem em 7 dias</p>
                  <p className="text-3xl font-bold mt-2 text-yellow-600">{stats.expiring_soon}</p>
                </div>
              </div>
            )}

            <div className="bg-white rounded-lg shadow">
              <div className="p-6 border-b">
                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <h2 className="text-xl font-bold">Clientes</h2>
                  <div className="flex gap-3">
                    <input type="text" placeholder="Buscar..." value={search} onChange={(e) => setSearch(e.target.value)} className="px-4 py-2 border rounded-lg" />
                    <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} className="px-4 py-2 border rounded-lg">
                      <option value="">Todos</option>
                      <option value="active">Ativos</option>
                      <option value="expired">Vencidos</option>
                      <option value="expiring">Vencendo</option>
                    </select>
                    <button onClick={() => { setEditingClient(null); setShowModal('client'); }} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">+ Novo</button>
                  </div>
                </div>
              </div>

              <div className="overflow-x-auto">
                {loading ? (
                  <div className="text-center py-12">Carregando...</div>
                ) : clients.length === 0 ? (
                  <div className="text-center py-12 text-gray-500">Nenhum cliente encontrado</div>
                ) : (
                  <table className="w-full">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">WhatsApp</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Plano</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Servidor</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vencimento</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {clients.map(client => (
                        <tr key={client.id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap font-medium">{client.name}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{client.whatsapp_number}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{client.plan_name}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{client.server_name}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">R$ {parseFloat(client.price_value).toFixed(2)}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{new Date(client.due_date).toLocaleDateString('pt-BR')}</td>
                          <td className="px-6 py-4 whitespace-nowrap">{getStatusBadge(client)}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-right text-sm space-x-2">
                            <button onClick={() => { setEditingClient(client); setShowModal('client'); }} className="text-blue-600 hover:text-blue-900">Editar</button>
                            <button onClick={() => handleDeleteClient(client.id)} className="text-red-600 hover:text-red-900">Excluir</button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </div>
            </div>
          </main>

          {showModal === 'whatsapp' && <WhatsAppModal onClose={() => setShowModal(null)} />}
          {showModal === 'plans' && <PlansModal plans={plans} onClose={() => setShowModal(null)} onRefresh={loadData} />}
          {showModal === 'servers' && <ServersModal servers={servers} onClose={() => setShowModal(null)} onRefresh={loadData} />}
          {showModal === 'templates' && <TemplatesModal templates={templates} onClose={() => setShowModal(null)} onRefresh={loadData} />}
          {showModal === 'reminders' && <RemindersModal reminders={reminders} templates={templates} onClose={() => setShowModal(null)} onRefresh={loadData} />}
          {showModal === 'client' && <ClientModal client={editingClient} plans={plans} servers={servers} onClose={() => setShowModal(null)} onSave={() => { setShowModal(null); loadData(); }} />}
        </div>
      );
    }

    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const token = localStorage.getItem('user_token');
        const userData = localStorage.getItem('user_data');
        if (token && userData) {
          try {
            const parsed = JSON.parse(userData);
            if (parsed.role !== 'admin') setUser(parsed);
            else handleLogout();
          } catch (error) {
            handleLogout();
          }
        }
        setLoading(false);
      }, []);

      const handleLogin = (userData) => setUser(userData);
      const handleLogout = () => {
        localStorage.removeItem('user_token');
        localStorage.removeItem('user_data');
        setUser(null);
      };

      if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="text-center"><div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"></div><p className="mt-4 text-gray-600">Carregando...</p></div></div>;
      if (!user) return <Login onLogin={handleLogin} />;
      return <Dashboard user={user} onLogout={handleLogout} />;
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
